
$schema: https://azuremlschemas.azureedge.net/latest/commandComponent.schema.json
type: command

name: test
display_name: Test
description: Test model on test set
version: 0.0.1
is_deterministic: true

inputs:
  model_input:
    type: uri_folder
  images_input:
    type: uri_folder
  integration_input:
    type: uri_folder

outputs:
  model_output:
    type: uri_folder
  integration_output:
    type: uri_folder

environment:
  name: test_environment
  build:
    path: ./

code: ./

additional_includes:
   - "../../packages/mlopspython-inference"

command: |
  set -euo pipefail

  python -m pip install --upgrade pip uv
  uv venv

  mkdir -p train/step
  mkdir -p packages
  mv ./mlopspython-inference ./packages

  # Copie tout sauf "packages" et "train"
  sh -c 'find . -mindepth 1 -maxdepth 1 \
      ! -name packages \
      ! -name train \
      -exec cp -a {} ./train/step/ \;'

  cd train/step

  UV_HTTP_TIMEOUT=300 uv sync --no-editable
  
  uv run python command.py \
  --model_input ${{inputs.model_input}} \
  --images_input ${{inputs.images_input}} \
  --integration_input ${{inputs.integration_input}} \
  --model_output ${{outputs.model_output}} \
  --integration_output ${{outputs.integration_output}}
